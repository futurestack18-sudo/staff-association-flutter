{% extends 'base.html' %}
{% block content %}

<h3>Welcome {{ current_user.name }}</h3>
<p><strong>Staff ID:</strong> {{ current_user.staff_id or 'Not assigned yet' }}</p>

<!-- Scan to Pay button -->
<div class="mb-3">
  <button type="button" class="btn btn-success" onclick="toggleScanner()" aria-label="Toggle Scan to Pay section">
    Scan to Pay
  </button>
</div>

<div id="scannerBox" class="scanner-box mb-4">
  <h5>Scan this to make your payment:</h5>
  <img src="{{ url_for('static', filename='img/scanner.png') }}" 
       alt="Scan to Pay" 
       class="img-fluid rounded shadow">
</div>

<hr>

<!-- Payments Section -->
<h4 class="mb-2 text-uppercase fw-bold text-dark border-bottom pb-2">Your Payments</h4>
<p><strong>Total Paid:</strong> <span class="text-success fw-bold">₹{{ "%.2f"|format(total_payments) }}</span></p>

{% if payments %}
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle shadow-sm border">
    <thead class="payment-table-header text-center fw-bold">
      <tr>
        <th>Amount (₹)</th>
        <th>Month</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      {% for p in payments %}
      <tr>
        <td>₹{{ "%.2f"|format(p.amount) }}</td>
        <td>{{ p.month }}</td>
        <td>{{ p.created_on.strftime('%Y-%m-%d') }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p class="text-muted">No payments recorded yet.</p>
{% endif %}

<hr>

<!-- Loans Section -->
<h4 class="mb-2 text-uppercase fw-bold text-dark border-bottom pb-2">Your Loans</h4>
{% if loans %}
  <p><strong>Total Active Loan Balance:</strong> 
     <span class="text-danger fw-bold">₹{{ "%.2f"|format(total_loans) }}</span>
  </p>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle shadow-sm border">
      <thead class="loan-table-header text-center fw-bold">
        <tr>
          <th>Principal (₹)</th>
          <th>Interest %</th>
          <th>Total Payable (₹)</th>
          <th>Paid (₹)</th>
          <th>Balance (₹)</th>
          <th>Status</th>
          <th>Requested On</th>
        </tr>
      </thead>
      <tbody>
        {% for l in loans %}
        <tr class="{% if l.status == 'approved' %}table-success{% elif l.status == 'pending' %}table-warning{% elif l.status == 'rejected' %}table-danger{% elif l.status == 'paid' or l.status == 'closed' %}table-info{% endif %}">
          <td class="text-end">₹{{ "%.2f"|format(l.amount) }}</td>
          <td class="text-center">{{ "%.1f"|format(l.interest_rate or 0) }}%</td>
          <td class="text-end fw-bold">₹{{ "%.2f"|format(l.total_amount or 0) }}</td>
          <td class="text-end text-primary">₹{{ "%.2f"|format(l.paid_amount or 0) }}</td>
          <td class="text-end text-danger">₹{{ "%.2f"|format(l.balance_amount or 0) }}</td>
          <td class="text-center fw-bold text-uppercase">{{ l.status }}</td>
          <td class="text-center">{{ l.requested_on.strftime('%Y-%m-%d') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

{% else %}
  <p class="text-muted">No loans recorded yet.</p>
{% endif %}

<!-- Loan Request Button -->
<div class="mt-3">
  <a class="btn btn-primary" href="{{ url_for('routes.staff_request_loan') }}">Request Loan</a>
</div>

<script>
function toggleScanner() {
    const box = document.getElementById("scannerBox");
    if (box) {
        box.classList.toggle('visible');
    }
}
</script>

{% endblock %}
