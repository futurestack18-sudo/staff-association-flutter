{% extends 'base.html' %}
{% block content %}
<div class="container mt-4 manage-loans-container">
  <h2 class="mb-3 text-center">Manage All Loans</h2>

  <table class="table table-striped table-bordered align-middle">
    <thead class="table-dark text-center">
      <tr>
        <th>ID</th>
        <th>Staff ID</th>
        <th>Principal (₹)</th>
        <th>Interest %</th>
        <th>Tenure (Months)</th>
        <th>Total (₹)</th>
        <th>Paid (₹)</th>
        <th>Balance (₹)</th>
        <th>Status</th>
        <th>Requested On</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      {% for l in loans %}
      <tr class="
        {% if l.deleted %}table-secondary
        {% elif l.status == 'approved' %}table-success
        {% elif l.status == 'rejected' %}table-danger
        {% elif l.status == 'paid' %}table-info
        {% else %}table-warning{% endif %}
      ">
        <td class="text-center">{{ l.id }}</td>
        <td class="text-center">{{ l.staff_id }}</td>
        <td class="text-end">₹{{ "%.2f"|format(l.amount) }}</td>
        <td class="text-center">{{ "%.1f"|format(l.interest_rate or 0) }}%</td>
        <td class="text-center">{{ l.tenure_months or '-' }}</td>
        <td class="text-end fw-bold">₹{{ "%.2f"|format(l.total_amount or 0) }}</td>
        <td class="text-end text-primary">₹{{ "%.2f"|format(l.paid_amount or 0) }}</td>
        <td class="text-end text-danger">₹{{ "%.2f"|format(l.balance_amount or 0) }}</td>
        <td class="text-center">{{ l.status|capitalize }}</td>
        <td class="text-center">{{ l.requested_on.strftime('%Y-%m-%d') }}</td>

        <td class="text-center">
          {% if not l.deleted %}
            <!-- Update Payment -->
            <form method="POST" 
                  action="{{ url_for('routes.admin_loan_update', id=l.id) }}" 
                  class="d-inline-flex loan-update-form" 
                  aria-label="Update payment for {{ l.staff_id }}">
              <input 
                type="number" 
                name="payment" 
                class="form-control form-control-sm loan-payment-input" 
                placeholder="Enter amount"
                title="Enter payment amount"
                min="0" 
                step="0.01" 
                required>
              <button type="submit" class="btn btn-sm btn-outline-primary loan-update-btn">
                Update
              </button>
            </form>

            <!-- Delete Button (only if paid fully) -->
            {% if l.balance_amount == 0 %}
            <form method="POST" 
                  action="{{ url_for('routes.admin_loan_delete', id=l.id) }}" 
                  class="d-inline loan-delete-form" 
                  aria-label="Delete fully paid loan {{ l.id }}">
              <button type="submit"
                      class="btn btn-sm btn-outline-danger loan-delete-btn"
                      onclick="return confirm('Are you sure you want to archive this fully paid loan?');">
                Delete
              </button>
            </form>
            {% endif %}
          {% else %}
            <span class="text-muted">Deleted</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if loans|length == 0 %}
  <div class="alert alert-info mt-3 text-center">No loan records found.</div>
  {% endif %}
</div>
{% endblock %}
